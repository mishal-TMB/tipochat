<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–¢–∏–ø–æ—á–∞—Ç - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —ç–∫—Ä–∞–Ω */
        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ - –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
        }

        /* –®–∞–ø–∫–∞ */
        .chat-header {
            background: #4a3f9c;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chat-header h1 {
            font-size: clamp(16px, 4vw, 20px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-info {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: clamp(12px, 3vw, 14px);
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .header-buttons button,
        .header-buttons a {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: clamp(12px, 3vw, 14px);
            cursor: pointer;
            text-decoration: none;
        }

        .header-buttons button:active,
        .header-buttons a:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - –≥–∏–±–∫–∞—è —Å–µ—Ç–∫–∞ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: row;
        }

        /* –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö —Å–∞–π–¥–±–∞—Ä –º–æ–∂–µ—Ç —Å–∫—Ä—ã–≤–∞—Ç—å—Å—è */
        @media (max-width: 768px) {
            .main-content {
                position: relative;
            }
        }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 260px;
            background: #f5f5f5;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        /* –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö —Å–∞–π–¥–±–∞—Ä —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -260px;
                top: 0;
                bottom: 0;
                z-index: 90;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
                width: 80%;
                max-width: 300px;
            }

            .sidebar.open {
                left: 0;
            }

            /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º —Å–∞–π–¥–±–∞—Ä–µ */
            .sidebar.open + .chat-area::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 80;
                pointer-events: none;
            }
        }

        /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
        .menu-toggle {
            display: none;
            background: #4a3f9c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 18px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }

        .sidebar h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .room-list {
            list-style: none;
            margin-bottom: 20px;
        }

        .room-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            word-break: break-word;
        }

        .room-item:active {
            background: #e0e0e0;
            transform: scale(0.98);
        }

        .room-item.active {
            background: #4a3f9c;
            color: white;
        }

        .room-item small {
            color: #999;
            font-size: 11px;
            margin-left: auto;
            white-space: nowrap;
        }

        .room-item.active small {
            color: rgba(255,255,255,0.8);
        }

        /* –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã */
        .create-room {
            margin-bottom: 20px;
        }

        .create-room input {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .create-room button {
            width: 100%;
            padding: 12px;
            background: #4a3f9c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }

        .create-room button:active {
            background: #5a4fbc;
            transform: scale(0.98);
        }

        /* –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ */
        .online-users {
            margin-top: 20px;
        }

        .online-list {
            list-style: none;
            padding: 0;
        }

        .online-item {
            padding: 10px 12px;
            margin-bottom: 3px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            display: inline-block;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            position: relative;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            background: white;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 85%;
            width: fit-content;
            animation: fadeIn 0.3s ease;
            word-break: break-word;
        }

        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∞ */
        .message.own {
            background: #4a3f9c;
            color: white;
            margin-left: auto;
        }

        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .message.system {
            background: #eee;
            text-align: center;
            font-style: italic;
            color: #666;
            max-width: 100%;
            width: 100%;
            font-size: 12px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
            gap: 10px;
        }

        .message.own .message-header {
            color: rgba(255,255,255,0.8);
        }

        .username {
            font-weight: bold;
        }

        .time {
            color: #999;
            font-size: 10px;
        }

        .message.own .time {
            color: rgba(255,255,255,0.8);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        /* –ö–∞—Ä—Ç–∏–Ω–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
        .message img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 8px;
        }

        /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ */
        .input-area {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #eee;
        }

        .user-info {
            margin-bottom: 10px;
        }

        #username {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            background: #f0f0f0;
        }

        /* –ü–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ –∏ –≤–≤–æ–¥–∞ */
        .message-input {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .message-input button {
            padding: 12px;
            background: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-input button:active {
            background: #e0e0e0;
            transform: scale(0.95);
        }

        #messageInput {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .send-btn {
            background: #4a3f9c !important;
            color: white !important;
        }

        .status {
            text-align: center;
            margin-top: 8px;
            font-size: 11px;
            color: #999;
        }

        .status.connected {
            color: #4CAF50;
        }

        /* –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ */
        #emojiPanel {
            position: absolute;
            bottom: 80px;
            right: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 10px;
            max-width: 300px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            #emojiPanel {
                position: fixed;
                bottom: 100px;
                right: 10px;
                left: 10px;
                max-width: none;
                width: auto;
            }
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }

        .emoji {
            cursor: pointer;
            font-size: 28px;
            text-align: center;
            padding: 5px;
            border-radius: 8px;
        }

        .emoji:active {
            background: #f0f0f0;
            transform: scale(1.2);
        }

        /* –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        #imagePreview {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        #previewImg {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
        }

        #clearImage {
            padding: 8px 15px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è */
        #inviteModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 15px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
        }

        .modal-content h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .invite-link-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .invite-link-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .invite-link-box button {
            padding: 12px 20px;
            background: #4a3f9c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .modal-close {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 85;
        }

        .overlay.active {
            display: block;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã */
        audio {
            display: none;
        }
    </style>
</head>
<body>
    <!-- –ó–≤—É–∫–∏ -->
    <audio id="messageSound" preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" type="audio/mpeg">
    </audio>
    <audio id="joinSound" preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/pop-1.mp3" type="audio/mpeg">
    </audio>

    <div class="chat-container">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <h1>
                    <span>üí¨ –¢–∏–ø–æ—á–∞—Ç</span>
                </h1>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span class="room-info" id="currentRoomDisplay">–æ–±—â–∞—è</span>
                <div class="header-buttons">
                    <button onclick="toggleSound()" id="soundToggle">üîä</button>
                    <button onclick="showInvite()">üîó</button>
                    <a href="/logout">üö™</a>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
            <div class="overlay" id="overlay" onclick="closeSidebar()"></div>

            <!-- –°–∞–π–¥–±–∞—Ä -->
            <div class="sidebar" id="sidebar">
                <h3>–ö–æ–º–Ω–∞—Ç—ã</h3>
                <ul class="room-list" id="roomList">
                    <li class="room-item active" onclick="joinRoom('general')">üè† –û–±—â–∞—è <small>–≤—Å–µ–≥–¥–∞</small></li>
                </ul>

                <div class="create-room">
                    <h3>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h3>
                    <input type="text" id="newRoomName" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ" maxlength="20">
                    <button onclick="createRoom()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
                </div>

                <div class="online-users">
                    <h3>–û–Ω–ª–∞–π–Ω (<span id="onlineCount">0</span>)</h3>
                    <ul id="onlineList" class="online-list"></ul>
                </div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
            <div class="chat-area">
                <div class="messages-area" id="messages"></div>

                <div class="input-area">
                    <div class="user-info">
                        <input type="text" id="username" placeholder="–í–∞—à –Ω–∏–∫" readonly>
                    </div>

                    <div class="message-input">
                        <button onclick="toggleEmojiPanel()">üòä</button>
                        <button onclick="document.getElementById('fileInput').click()">üì∑</button>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                        <button onclick="sendMessage()" class="send-btn">‚û§</button>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ -->
                    <div id="emojiPanel">
                        <div class="emoji-grid">
                            <span class="emoji">üòä</span>
                            <span class="emoji">üòÇ</span>
                            <span class="emoji">‚ù§Ô∏è</span>
                            <span class="emoji">üëç</span>
                            <span class="emoji">üéâ</span>
                            <span class="emoji">üî•</span>
                            <span class="emoji">üò¢</span>
                            <span class="emoji">üòé</span>
                            <span class="emoji">ü•∫</span>
                            <span class="emoji">üò°</span>
                            <span class="emoji">ü§î</span>
                            <span class="emoji">üëÄ</span>
                            <span class="emoji">üôè</span>
                            <span class="emoji">üíÄ</span>
                            <span class="emoji">üëª</span>
                            <span class="emoji">ü§°</span>
                            <span class="emoji">üê±</span>
                            <span class="emoji">üê∂</span>
                            <span class="emoji">üêº</span>
                            <span class="emoji">ü¶ä</span>
                            <span class="emoji">üçï</span>
                            <span class="emoji">üçî</span>
                            <span class="emoji">‚öΩ</span>
                            <span class="emoji">üèÄ</span>
                        </div>
                    </div>

                    <!-- –ü—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∏ -->
                    <div id="imagePreview">
                        <img id="previewImg">
                        <button id="clearImage">‚úñ –£–¥–∞–ª–∏—Ç—å</button>
                    </div>

                    <div class="status" id="connectionStatus">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    <div id="inviteModal">
        <div class="modal-content">
            <h3>üîó –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É</h3>
            <p style="margin-bottom: 10px;">–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–≥—É:</p>
            <div class="invite-link-box">
                <input type="text" id="inviteLink" readonly>
                <button onclick="copyInviteLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            <button class="modal-close" onclick="closeInvite()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –∏–∑ URL –µ—Å–ª–∏ –µ—Å—Ç—å
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoom = urlParams.get('room') || 'general';

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentRoom = urlRoom;
        let username = '{{ current_user.username }}';
        let selectedFile = null;
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';

        document.getElementById('username').value = username;
        document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîà';

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
        var socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            timeout: 20000
        });

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const statusEl = document.getElementById('connectionStatus');
        const currentRoomDisplay = document.getElementById('currentRoomDisplay');
        const messagesEl = document.getElementById('messages');
        const roomList = document.getElementById('roomList');
        const onlineList = document.getElementById('onlineList');
        const onlineCount = document.getElementById('onlineCount');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        currentRoomDisplay.textContent = currentRoom === 'general' ? '–æ–±—â–∞—è' : currentRoom;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatMessageTime(timestamp) {
            const now = new Date();
            const [hours, minutes] = timestamp.split(':');
            return `—Å–µ–≥–æ–¥–Ω—è –≤ ${hours}:${minutes}`;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addMessage(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            if (msg.username === username && msg.username !== '–°–∏—Å—Ç–µ–º–∞') {
                messageDiv.classList.add('own');
            }
            if (msg.username === '–°–∏—Å—Ç–µ–º–∞') {
                messageDiv.classList.add('system');
            }

            const time = msg.timestamp || new Date().toLocaleTimeString();

            let content = '';
            if (msg.image) {
                content = `<img src="${msg.image}" alt="image">`;
            }

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(msg.username)}</span>
                    <span class="time">${formatMessageTime(time)}</span>
                </div>
                <div class="message-text">${escapeHtml(msg.text)}</div>
                ${content}
            `;

            messagesEl.appendChild(messageDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîà';
        }

        function playSound(type) {
            if (!soundEnabled) return;
            if (type === 'message') {
                document.getElementById('messageSound').play().catch(e => {});
            } else if (type === 'join') {
                document.getElementById('joinSound').play().catch(e => {});
            }
        }

        // –ü–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        document.querySelectorAll('.emoji').forEach(emoji => {
            emoji.addEventListener('click', function() {
                const input = document.getElementById('messageInput');
                input.value += this.textContent;
                input.focus();
                document.getElementById('emojiPanel').style.display = 'none';
            });
        });

        document.addEventListener('click', function(event) {
            const panel = document.getElementById('emojiPanel');
            const emojiBtn = document.querySelector('.message-input button:first-child');

            if (panel && emojiBtn && !panel.contains(event.target) && !emojiBtn.contains(event.target)) {
                panel.style.display = 'none';
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 5MB');
                    return;
                }

                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('clearImage').addEventListener('click', function() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('messageInput');

            if (input.value.trim() || selectedFile) {
                if (selectedFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const messageData = {
                            username: username,
                            text: input.value || 'üì∑ –§–æ—Ç–æ',
                            image: e.target.result,
                            room: currentRoom,
                            timestamp: new Date().toLocaleTimeString()
                        };
                        socket.emit('send_message', messageData);
                        document.getElementById('clearImage').click();
                        input.value = '';
                    };
                    reader.readAsDataURL(selectedFile);
                } else {
                    const messageData = {
                        username: username,
                        text: input.value,
                        room: currentRoom,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    socket.emit('send_message', messageData);
                    input.value = '';
                }
            }
        }

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Socket —Å–æ–±—ã—Ç–∏—è
        socket.on('connect', function() {
            statusEl.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            statusEl.className = 'status connected';

            socket.emit('join', {
                username: username,
                room: currentRoom
            });

            socket.emit('get_history', { room: currentRoom });
        });

        socket.on('disconnect', function() {
            statusEl.innerHTML = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
            statusEl.className = 'status';
        });

        socket.on('new_message', function(msg) {
            if (msg.room === currentRoom || !msg.room) {
                addMessage(msg);
                if (msg.username !== username && msg.username !== '–°–∏—Å—Ç–µ–º–∞') {
                    playSound('message');
                }
            }
        });

        socket.on('online_users', function(users) {
            onlineCount.textContent = users.length;
            onlineList.innerHTML = '';

            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'online-item';
                li.innerHTML = `
                    <span class="online-dot"></span>
                    <span>${escapeHtml(user.username)}</span>
                `;
                onlineList.appendChild(li);
            });
        });

        socket.on('error_message', function(data) {
            alert(data.text);
        });

        // –°–º–µ–Ω–∞ –∫–æ–º–Ω–∞—Ç—ã
        function joinRoom(room) {
            if (room === currentRoom) {
                closeSidebar();
                return;
            }

            currentRoom = room;
            currentRoomDisplay.textContent = room === 'general' ? '–æ–±—â–∞—è' : room;
            messagesEl.innerHTML = '';

            socket.emit('join', {
                username: username,
                room: currentRoom
            });

            socket.emit('get_history', { room: currentRoom });

            document.querySelectorAll('.room-item').forEach(el => {
                el.classList.remove('active');
                if (el.textContent.includes(room) || (room === 'general' && el.textContent.includes('–û–±—â–∞—è'))) {
                    el.classList.add('active');
                }
            });

            const url = new URL(window.location);
            url.searchParams.set('room', room);
            window.history.pushState({}, '', url);

            closeSidebar();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function createRoom() {
            const newRoom = document.getElementById('newRoomName').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
            if (!newRoom) return;

            const li = document.createElement('li');
            li.className = 'room-item';
            li.onclick = () => joinRoom(newRoom);
            li.innerHTML = `üîê ${newRoom} <small>–ø—Ä–∏–≤–∞—Ç–Ω–∞—è</small>`;
            roomList.appendChild(li);

            joinRoom(newRoom);
            document.getElementById('newRoomName').value = '';
        }

        // –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
        function showInvite() {
            const modal = document.getElementById('inviteModal');
            const link = `${window.location.origin}?room=${currentRoom}`;
            document.getElementById('inviteLink').value = link;
            modal.style.display = 'flex';
        }

        function closeInvite() {
            document.getElementById('inviteModal').style.display = 'none';
        }

        function copyInviteLink() {
            const link = document.getElementById('inviteLink');
            link.select();
            link.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('inviteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        window.onload = function() {
            addMessage({
                username: '–°–∏—Å—Ç–µ–º–∞',
                text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç! –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã –∏ –ø—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ —Å—Å—ã–ª–∫–µ.',
                timestamp: new Date().toLocaleTimeString()
            });
        };
    </script>
</body>
</html>